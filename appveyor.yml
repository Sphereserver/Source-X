# Do not build on tags (GitHub only)
skip_tags: true

# Do not increment the current build number after each automatic build
#pull_requests:
#  do_not_increment_build_number: true

# Branches to build
branches:
  only:
    - master

# Version format
version: 1.1.0.{build}

# Set up two building environments (two first class elements in the build matrix)
image:
  - Visual Studio 2017

# Environmental variables
environment:
  # Common to all the builds of the matrix
  BUILD_DIR_64: build-64


# Build scripts
   # Windows build
    matrix:
      only:
        - image: Visual Studio 2017

    environment:
      MSBUILD_FLAGS: /verbosity:minimal /maxcpucount
      CMAKE_GEN_64: Visual Studio 15 2017 Win64

    install:
      # Report our building tools
      - msbuild /version
      - cmake --version

    # Use our custom script instead of automatic MSBuild
    build_script:    
      - mkdir %BUILD_DIR_64%
      - cd "%BUILD_DIR_64%"

      - IF DEFINED APPVEYOR_PULL_REQUEST_NUMBER (
          ECHO. && ECHO ** Starting to build 64 bits Nightly version to test the Pull Request && ECHO.
        ) ELSE (
          ECHO. $$ECHO ** Starting to build 64 bits Nightly version && ECHO.
        )
      - cmake -G "%CMAKE_GEN_64%" ..\src
      - msbuild SphereServer.sln %MSBUILD_FLAGS% /p:Configuration=Nightly
      - ECHO. && ECHO ** End of the compilation of the 64 bits Nightly version && ECHO.

      - cd ..

    after_build:
      # if we are testing a pull request, we don't want to upload the build to the host
      - IF DEFINED APPVEYOR_PULL_REQUEST_NUMBER (appveyor exit)

      - ECHO ** Compilation done. Packing the files and uploading to SphereCommunity
      - mkdir accounts logs save scripts
      - 7z a SphereSvrX-win64-nightly.zip accounts\ logs\ save\ scripts\ "%APPVEYOR_BUILD_FOLDER%\%BUILD_DIR_64%\bin64\Nightly\SphereSvrX64_nightly.exe" "%APPVEYOR_BUILD_FOLDER%\src\sphere.ini" "%APPVEYOR_BUILD_FOLDER%\src\sphereCrypt.ini" "%APPVEYOR_BUILD_FOLDER%\dlls\64\libmysql.dll"

    artifacts:
      - path: SphereSvrX-win64-nightly.zip
