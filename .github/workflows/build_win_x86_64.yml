name: Windows x86_64

on:
  workflow_dispatch:   # Allow manual trigger from GitHub Actions UI
  push:
    branches:
      - 'master'
      - 'main'
      - 'dev'
    paths-ignore:
      - '.gitignore'
      - '.gitattributes'
      - '**.txt'
      - '**.md'
      - '**.rc'
  pull_request:
    branches:
      - 'master'
      - 'main'
      - 'dev'

jobs:
  windows-x86_64:
    runs-on: windows-latest
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: CMake
        run: cmake -G "Visual Studio 17 2022" .\

      - name: MSBuild
        run: msbuild SphereServer.sln /verbosity:minimal /maxcpucount /p:Configuration=Nightly

      - name: Create package
        run: |
            pwd
            mkdir accounts, logs, save, scripts
            7z a SphereSvrX-win-x86_64-nightly.zip accounts\ logs\ save\ scripts\ .\bin-x86_64\Nightly\SphereSvrX64_nightly.exe .\src\sphere.ini .\src\sphereCrypt.ini .\lib\_bin\x86_64\mariadb\libmariadb.dll

      # Upload artifact for later release jobs (main/master/dev or PR)
      - name: Upload artifact
        if: contains(fromJson('["master", "main", "dev"]'), github.ref_name) || ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: Build-win-x86_64
          path: SphereSvrX-win-x86_64-nightly.zip
          overwrite: true

  # Release job for master/main → goes to "Nightly"
  upload_github_release_main:
    needs: windows-x86_64
    if: contains(fromJson('["master", "main"]'), github.ref_name)
    permissions:
      contents: write
      actions: write
    runs-on: ubuntu-latest

    steps:
      - name: Download builds
        uses: actions/download-artifact@v5
        with:
          name: Build-win-x86_64
          merge-multiple: true
          run-id: ${{ github.run_id }}

      - name: Upload to Nightly release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Nightly
          tag_name: Nightly
          prerelease: true
          files: SphereSvrX-win-x86_64-nightly.zip

  # Release job for dev → goes to "Dev Nightly"
  upload_github_release_dev:
    needs: windows-x86_64
    if: github.ref_name == 'dev'
    permissions:
      contents: write
      actions: write
    runs-on: ubuntu-latest

    steps:
      - name: Download builds
        uses: actions/download-artifact@v5
        with:
          name: Build-win-x86_64
          merge-multiple: true
          run-id: ${{ github.run_id }}

      - name: Upload to Dev Nightly release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Dev Nightly
          tag_name: Dev
          prerelease: true
          files: SphereSvrX-win-x86_64-nightly.zip

  # Optional self-host upload only for master/main
  upload_selfhost_release:
    needs: windows-x86_64
    # Run only on master/main AND only on the official SphereServer repo
    if: contains(fromJson('["master", "main"]'), github.ref_name) && (github.repository == 'SphereServer/Source-X')
    permissions:
      contents: write
      actions: read
    runs-on: ubuntu-latest

    steps:
      - name: Download builds
        uses: actions/download-artifact@v5
        with:
          name: Build-win-x86_64
          merge-multiple: true
          run-id: ${{ github.run_id }}

      # Push artifact to your self-hosted endpoint
      - name: Push release
        run: |
          curl -sST "{SphereSvrX-win-x86_64-nightly.zip}" -u ${{secrets.UP_USER}}:${{secrets.UP_PASS}} ${{secrets.UP_WHERE}}